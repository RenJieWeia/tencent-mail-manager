{% extends "base.html" %}

{% block title %}MailNest - 首页{% endblock %}

{% block styles %}
<style>
    .sidebar-wrapper {
        width: 320px; 
        border-right: 1px solid var(--border-color);
        background-color: var(--bs-body-bg);
        display: flex;
        flex-direction: column;
    }

    .content-wrapper {
        flex: 1;
        background-color: var(--bs-tertiary-bg);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .account-item {
        border-radius: 8px;
        margin-bottom: 4px;
        transition: background-color 0.2s;
        cursor: pointer;
        padding: 0.75rem 1rem;
        color: var(--bs-body-color);
    }
    
    .account-item:hover {
        background-color: var(--bs-tertiary-bg);
    }
    
    .account-item.active {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
        color: var(--bs-primary);
        font-weight: 500;
    }
    
    .action-btn-group {
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .account-item:hover .action-btn-group {
        opacity: 1;
    }

    .mail-container {
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex h-100 w-100 overflow-hidden">
    
    <!-- Sidebar -->
    <div class="sidebar-wrapper h-100 flex-shrink-0">
        <!-- Sidebar Header -->
        <div class="p-3 border-bottom d-flex align-items-center justify-content-between bg-body">
            <h6 class="mb-0 fw-bold text-uppercase text-body-secondary small ls-wider">公共邮箱池</h6>
            <span class="badge bg-body-secondary text-body border rounded-pill">{{ accounts|length }}</span>
        </div>

        <!-- Search Bar -->
        <div class="px-3 py-2 border-bottom bg-body-tertiary">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-body border-end-0 text-body-secondary"><i class="bi bi-search"></i></span>
                <input type="text" id="accountSearch" class="form-control border-start-0 ps-0 bg-body" placeholder="搜索邮箱..." onkeyup="filterAccounts()" style="box-shadow: none;">
            </div>
        </div>
        
        <!-- Account List -->
        <div class="flex-grow-1 overflow-auto p-2" id="account-list-container">
            {% if accounts %}
                <div class="d-flex flex-column" id="account-list-inner">
                    {% for acc in accounts %}
                    <div class="account-item d-flex justify-content-between align-items-center" 
                         onclick="loadMail({{ acc['id'] }}, this)"
                         data-id="{{ acc['id'] }}"
                         role="button">
                        <div class="d-flex align-items-center gap-3 text-truncate">
                            <div class="position-relative">
                                <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 icon-status 
                                    {% if acc['status'] == 'success' %}bg-success text-white{% elif acc['status'] == 'error' %}bg-danger text-white{% else %}bg-body-tertiary{% endif %}" 
                                    style="width: 32px; height: 32px;">
                                    <span class="fw-bold small {% if acc['status'] in ['success', 'error'] %}text-white{% else %}text-body-secondary{% endif %}">QQ</span>
                                </div>
                                {% if acc['has_new_mail'] %}
                                <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle new-mail-dot">
                                    <span class="visually-hidden">New alerts</span>
                                </span>
                                {% endif %}
                            </div>
                            <div class="d-flex flex-column text-truncate">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-truncate fw-medium account-email" style="font-size: 0.95rem;">{{ acc['email'] }}</span>
                                    {% if acc['has_new_mail'] %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger new-mail-badge" style="font-size: 0.65rem;">NEW</span>
                                    {% endif %}
                                </div>
                                <span class="small text-body-secondary" style="font-size: 0.75rem;">点击查看邮件</span>
                            </div>
                        </div>
                        <div class="action-btn-group">
                            <button class="btn btn-icon btn-sm text-danger hover-bg-danger-light rounded" 
                                    onclick="event.stopPropagation(); deleteAccount({{ acc['id'] }})"
                                    title="删除账号">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center p-4 text-body-secondary mt-5" id="empty-list-msg">
                    <div class="mb-3">
                        <i class="bi bi-envelope-x fs-1 opacity-25"></i>
                    </div>
                    <p class="small">暂无绑定账号</p>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addModal">立即添加</button>
                </div>
            {% endif %}
        </div>
        
        <!-- Sidebar Footer -->
        <div class="p-3 border-top bg-body mt-auto">
            {% if session.get('username') == 'renjie' %}
            <button class="btn btn-outline-primary w-100 mb-2 shadow-sm fw-medium py-2" data-bs-toggle="modal" data-bs-target="#pollingModal">
                <i class="bi bi-clock-history me-2"></i>轮询配置
            </button>
            {% endif %}
            <button class="btn btn-primary w-100 mb-2 shadow-sm fw-medium py-2" data-bs-toggle="modal" data-bs-target="#addModal">
                <i class="bi bi-plus-lg me-2"></i>添加新账号
            </button>
            <div class="row g-2">
                <div class="col-6">
                    <a href="/download_template" class="btn btn-outline-secondary w-100 btn-sm bg-body border-secondary-subtle text-body">
                        <i class="bi bi-download me-1"></i>模版
                    </a>
                </div>
                <div class="col-6">
                    <button class="btn btn-outline-secondary w-100 btn-sm bg-body border-secondary-subtle text-body" onclick="document.getElementById('excelFile').click()">
                        <i class="bi bi-upload me-1"></i>导入
                    </button>
                </div>
            </div>
            <input type="file" id="excelFile" accept=".xlsx, .xls" class="d-none" onchange="uploadExcel()"/>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-wrapper">
        <div id="mail-content-area" class="flex-grow-1 overflow-hidden w-100 d-flex flex-column p-4">
            <!-- Empty State -->
            <div class="m-auto text-center" id="empty-state">
                <div class="bg-body rounded-circle shadow-sm d-inline-flex p-5 mb-4 border">
                    <i class="bi bi-mailbox fs-1 text-primary opacity-50 display-4"></i>
                </div>
                <h4 class="fw-bold text-body mb-2">欢迎使用 MailNest</h4>
                <p class="text-body-secondary mb-4" style="max-width: 400px; margin: 0 auto;">
                    请从左侧列表选择一个邮箱账号，我们将为您获取最新的一封邮件内容。
                </p>
            </div>
        </div>
    </div>

</div>

<!-- Add Account Modal -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0 px-4 pt-4">
                <h5 class="modal-title fw-bold">绑定 QQ 邮箱</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-primary bg-primary bg-opacity-10 border-0 text-primary small d-flex gap-2 mb-4">
                    <i class="bi bi-info-circle-fill flex-shrink-0 mt-1"></i>
                    <div>需要开启 POP3/IMAP 服务并获取授权码（非 QQ 密码）。</div>
                </div>
                <form id="addForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary text-uppercase">邮箱地址</label>
                        <div class="input-group">
                            <span class="input-group-text bg-body-tertiary border-end-0"><i class="bi bi-envelope"></i></span>
                            <input type="email" class="form-control border-start-0 ps-0 bg-body" name="email" required placeholder="example@qq.com"/>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary text-uppercase">授权码</label>
                        <div class="input-group">
                            <span class="input-group-text bg-body-tertiary border-end-0"><i class="bi bi-key"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0 bg-body" name="auth_code" required placeholder="输入 16 位授权码"/>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary w-100 py-2 fw-medium" onclick="addAccount()">
                        确认绑定
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Polling Config Modal -->
{% if session.get('username') == 'renjie' %}
<div class="modal fade" id="pollingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0 px-4 pt-4">
                <h5 class="modal-title fw-bold">自动轮询配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="pollingForm">
                    <div class="alert alert-secondary bg-body-tertiary border-0 small text-secondary d-flex gap-2 mb-3">
                        <i class="bi bi-info-circle-fill flex-shrink-0 mt-1"></i>
                        <div>后台将根据设定时间间隔自动获取邮件。</div>
                    </div>
                
                    <div class="form-check form-switch mb-4 p-3 border rounded bg-body-tertiary d-flex align-items-center">
                        <input class="form-check-input ms-0 me-3" type="checkbox" role="switch" id="pollingEnabled" name="enabled" {% if polling_config and polling_config.enabled %}checked{% endif %}>
                        <label class="form-check-label fw-medium mb-0" for="pollingEnabled">开启自动轮询</label>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary text-uppercase">轮询间隔 (秒)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-body-tertiary border-end-0"><i class="bi bi-stopwatch"></i></span>
                            <input type="number" class="form-control border-start-0 ps-0 bg-body" name="interval" value="{{ polling_config.interval if polling_config else 300 }}" required min="10" placeholder="例如: 300"/>
                        </div>
                        <div class="form-text small mt-2"><i class="bi bi-exclamation-circle me-1"></i>被标记为通讯失败(Error)的邮箱将自动跳过。</div>
                    </div>
                    
                    <button type="button" class="btn btn-primary w-100 py-2 fw-medium" onclick="savePollingConfig()">
                        保存配置
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
async function addAccount() {
    const btn = document.querySelector('#addModal .btn-primary');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>处理中...';

    const form = document.getElementById('addForm');
    const formData = new FormData(form);
    
    try {
        const res = await fetch('/add', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.status === 'ok') {
            showToast('账号添加成功', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('添加失败', 'danger');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (e) {
        showToast('网络错误: ' + e, 'danger');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function deleteAccount(id) {
    if (!confirm('确定删除该账号吗？此操作无法撤销。')) return;
    try {
        const res = await fetch(`/delete/${id}`, { method: 'POST' });
        const data = await res.json();
        if (data.status === 'ok') {
            showToast('账号已删除', 'success');
            setTimeout(() => location.reload(), 500);
        }
    } catch (e) {
        showToast('删除失败: ' + e, 'danger');
    }
}

async function uploadExcel() {
    const fileInput = document.getElementById('excelFile');
    const file = fileInput.files[0];
    if (!file) return;

    // Toast loading
    showToast('正在导入账号，请稍候...', 'info');

    const formData = new FormData();
    formData.append('file', file);

    try {
        const res = await fetch('/upload_excel', { method: 'POST', body: formData });
        const data = await res.json();
        
        if (data.status === 'success') {
            showToast(`成功导入 ${data.count} 个账号`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message, 'danger');
        }
    } catch (e) {
        showToast('上传出错: ' + e, 'danger');
    }
    fileInput.value = '';
}

async function loadMail(accId, btnElement) {
    document.querySelectorAll('.account-item').forEach(el => el.classList.remove('active'));
    if (btnElement) btnElement.classList.add('active');
    
    const container = document.getElementById('mail-content-area');
    container.innerHTML = `
        <div class="h-100 w-100 d-flex flex-column align-items-center justify-content-center">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="text-body-secondary fw-medium">正在连接服务器获取邮件...</p>
        </div>
    `;
    
    try {
        const res = await fetch(`/check/${accId}`);
        const data = await res.json();
        
        // Update Icon Status UI
        if (btnElement) {
            const iconDiv = btnElement.querySelector('.icon-status');
            const iconText = iconDiv.querySelector('span');
            
            // Reset common classes
            iconDiv.className = 'rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 icon-status';
            
            if (data.status === 'success') {
                iconDiv.classList.add('bg-success', 'text-white');
                iconText.className = 'fw-bold small text-white';
            } else if (data.status === 'error') {
                iconDiv.classList.add('bg-danger', 'text-white');
                iconText.className = 'fw-bold small text-white';
            } else {
                 // Fallback or unknown
                iconDiv.classList.add('bg-body-tertiary');
                iconText.className = 'fw-bold text-body-secondary small';
            }
        }
        
        if (data.status === 'success') {
            container.innerHTML = `
                <div class="mail-container bg-body shadow-sm rounded-3 d-flex flex-column overflow-hidden" style="height: 100%;">
                    <div class="p-4 p-md-5 border-bottom flex-shrink-0">
                        <h2 class="fw-bold text-body mb-3" style="line-height: 1.4;">${data.subject}</h2>
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill fw-normal">收件箱</span>
                            <span class="text-body-secondary small border-start ps-3">发件人: <span class="fw-bold text-body">${data.sender}</span></span>
                        </div>
                    </div>
                    <div class="mail-body flex-grow-1 overflow-auto p-4 p-md-5 text-break fs-6 lh-lg text-body">
                        ${data.content}
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="d-flex h-100 align-items-center justify-content-center">
                    <div class="text-center p-5 bg-body rounded-4 shadow-sm border" style="max-width: 400px;">
                        <div class="text-danger mb-3"><i class="bi bi-x-circle fs-1"></i></div>
                        <h5 class="fw-bold text-body">获取失败</h5>
                        <p class="text-body-secondary mb-0">${data.message}</p>
                    </div>
                </div>
            `;
        }
    } catch (e) {
        container.innerHTML = `
             <div class="d-flex h-100 align-items-center justify-content-center">
                <div class="text-center p-5 bg-body rounded-4 shadow-sm border" style="max-width: 400px;">
                     <div class="text-danger mb-3"><i class="bi bi-exclamation-triangle fs-1"></i></div>
                     <h5 class="fw-bold text-body">系统错误</h5>
                     <p class="text-body-secondary mb-0">${e}</p>
                 </div>
             </div>
        `;
    }
}

function filterAccounts() {
    const input = document.getElementById('accountSearch');
    const filter = input.value.toLowerCase();
    const items = document.querySelectorAll('.account-item');

    items.forEach(item => {
        const emailSpan = item.querySelector('.account-email');
        if (emailSpan) {
            const email = emailSpan.textContent || emailSpan.innerText;
            if (email.toLowerCase().indexOf(filter) > -1) {
                item.classList.remove('d-none');
                item.classList.add('d-flex');
            } else {
                item.classList.add('d-none');
                item.classList.remove('d-flex');
            }
        }
    });
}

// Auto-Refresh Logic
let autoRefreshInterval = null;

function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(refreshAccountList, 5000); // 5 seconds
}

async function refreshAccountList() {
    // If user is searching/filtering, maybe pause? Or just apply filter after render.
    // For now, we continue.
    
    try {
        const res = await fetch('/?format=json', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const accounts = await res.json();
        
        // Find currently active item ID
        const activeItem = document.querySelector('.account-item.active');
        const activeId = activeItem ? parseInt(activeItem.getAttribute('data-id')) : null;
        
        const listContainer = document.getElementById('account-list-inner');
        if (!listContainer && accounts.length > 0) {
             // Maybe initially empty -> reload page to get structure or manually build container
             location.reload(); 
             return;
        }
        
        if (!accounts.length) {
             // Handle empty state if needed, but usually we just leave it or show empty msg
             return;
        }

        // Rebuild HTML
        // Note: Ideally use a frontend framework (Vue/React) or diffing library. 
        // Here we reconstruct HTML string.
        
        const html = accounts.map(acc => {
            const statusClass = acc.status === 'success' ? 'bg-success text-white' : 
                               (acc.status === 'error' ? 'bg-danger text-white' : 'bg-body-tertiary');
            const statusTextClass = (acc.status === 'success' || acc.status === 'error') ? 'text-white' : 'text-body-secondary';
            
            const newMailDot = acc.has_new_mail ? 
                `<span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle new-mail-dot">
                     <span class="visually-hidden">New alerts</span>
                 </span>` : '';
            
            const newMailBadge = acc.has_new_mail ?
                `<span class="badge bg-danger bg-opacity-10 text-danger new-mail-badge" style="font-size: 0.65rem;">NEW</span>` : '';
            
            const isActive = activeId === acc.id ? 'active' : '';
            
            return `
            <div class="account-item d-flex justify-content-between align-items-center ${isActive}" 
                    onclick="loadMail(${acc.id}, this)"
                    data-id="${acc.id}"
                    role="button">
                <div class="d-flex align-items-center gap-3 text-truncate">
                    <div class="position-relative">
                        <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 icon-status ${statusClass}" 
                            style="width: 32px; height: 32px;">
                            <span class="fw-bold small ${statusTextClass}">QQ</span>
                        </div>
                        ${newMailDot}
                    </div>
                    <div class="d-flex flex-column text-truncate">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-truncate fw-medium account-email" style="font-size: 0.95rem;">${acc.email}</span>
                            ${newMailBadge}
                        </div>
                        <span class="small text-body-secondary" style="font-size: 0.75rem;">点击查看邮件</span>
                    </div>
                </div>
                <div class="action-btn-group">
                    <button class="btn btn-icon btn-sm text-danger hover-bg-danger-light rounded" 
                            onclick="event.stopPropagation(); deleteAccount(${acc.id})"
                            title="删除账号">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>`;
        }).join('');
        
        listContainer.innerHTML = html;
        
        // Re-apply filter if any
        const searchInput = document.getElementById('accountSearch');
        if (searchInput && searchInput.value) {
            filterAccounts();
        }
        
    } catch (e) {
        console.error("Auto refresh failed", e);
    }
}

// Start auto refresh
startAutoRefresh();

async function savePollingConfig() {
    const btn = document.querySelector('#pollingModal .btn-primary');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';

    const enabled = document.getElementById('pollingEnabled').checked;
    const interval = document.querySelector('input[name="interval"]').value;
    
    const formData = new FormData();
    formData.append('enabled', enabled);
    formData.append('interval', interval);
    
    try {
        const res = await fetch('/polling/config', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.status === 'ok') {
            showToast('轮询配置已更新', 'success');
            // Close modal
            const modalEl = document.getElementById('pollingModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            // Optional: reload to refresh server-side state provided to template
            setTimeout(() => location.reload(), 500); 
        } else {
            showToast('保存失败: ' + data.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (e) {
        showToast('网络错误: ' + e, 'danger');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

</script>
{% endblock %}
