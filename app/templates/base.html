<!DOCTYPE html>
<html lang="zh" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MailNest{% endblock %}</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #4f46e5;
        --sidebar-width: 320px;
        --border-color: var(--bs-border-color);
        --bg-body: var(--bs-body-bg);
      }
      
      [data-bs-theme="dark"] {
           --primary-color: #818cf8;
      }

      body {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      
      /* Subtle transitions */
      body, .navbar, .card, .list-group-item {
          transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      }

      .navbar {
        height: 64px;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bs-body-bg);
      }
      
      .navbar-brand {
        font-weight: 700;
        letter-spacing: -0.025em;
        color: var(--primary-color) !important;
      }
      
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }
      
      /* SPA-like transitions */
      .fade-in {
          animation: fadeIn 0.3s ease-in-out;
      }
      
      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(5px); }
          to { opacity: 1; transform: translateY(0); }
      }
      
      /* Custom Scrollbar for modern look */
      ::-webkit-scrollbar {
          width: 8px;
          height: 8px;
      }
      ::-webkit-scrollbar-track {
          background: transparent;
      }
      ::-webkit-scrollbar-thumb {
          background-color: var(--bs-secondary-bg);
          border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
          background-color: var(--bs-secondary-color);
      }
      
      .btn-primary {
         background-color: var(--primary-color);
         border-color: var(--primary-color);
      }
      .btn-primary:hover {
         filter: brightness(0.9);
      }

      .toast-container {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1060;
      }
    </style>
    {% block styles %}{% endblock %}
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg px-3">
      <div class="container-fluid">
        <a href="{{ url_for('main.index') }}" class="d-flex align-items-center gap-2 text-decoration-none">
            <div class="d-flex align-items-center justify-content-center bg-primary text-white rounded-3" style="width: 32px; height: 32px;">
                <i class="bi bi-envelope-paper-fill"></i>
            </div>
            <span class="navbar-brand mb-0 h1 fs-5">MailNest</span>
            <span class="text-body-secondary border-start ps-3 ms-2 small d-none d-sm-inline-block">QQ邮箱集中管理</span>
        </a>
        
        <div class="d-flex gap-3 align-items-center">
            <!-- Theme Toggle -->
            <button class="btn btn-link nav-link p-0 text-body" id="themeToggle" title="Toggle Theme">
                <i class="bi bi-moon-stars-fill fs-5" id="themeIcon"></i>
            </button>

            {% if session.get('username') %}
            <div class="dropdown">
                <button class="btn btn-link text-decoration-none border-0 p-1 rounded-pill pe-3 hover-bg-light text-body" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="d-flex align-items-center gap-2">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center shadow-sm" 
                             style="width: 36px; height: 36px; font-weight: 600; font-size: 14px;">
                            {{ session.get('username')[0].upper() }}
                        </div>
                        <div class="d-flex flex-column align-items-start lh-1 d-none d-sm-flex">
                            <span class="fw-semibold small">{{ session.get('username') }}</span>
                            <span class="text-body-secondary" style="font-size: 10px;">
                                {% if session.get('username') == 'renjie' %}
                                    <span class="text-primary">Super Admin</span>
                                {% elif session.get('username') == 'admin' %}
                                    Admin
                                {% else %}
                                    User
                                {% endif %}
                            </span>
                        </div>
                        <i class="bi bi-chevron-down text-body-secondary small ms-1"></i>
                    </div>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2 rounded-3 p-2">
                    <li><h6 class="dropdown-header text-uppercase small fw-bold text-body-secondary">我的账户</h6></li>
                    <li><a class="dropdown-item rounded-2 py-2" href="{{ url_for('main.profile') }}"><i class="bi bi-person-gear me-2"></i>个人设置</a></li>
                    
                    {% if session.get('username') in ['admin', 'renjie'] %}
                    <li><h6 class="dropdown-header text-uppercase small fw-bold text-body-secondary mt-2">系统管理</h6></li>
                    {% if g.can_access_dashboard %}
                    <li><a class="dropdown-item rounded-2 py-2 text-primary" href="{{ url_for('admin.dashboard') }}"><i class="bi bi-speedometer2 me-2"></i>控制台</a></li>
                    {% endif %}
                    <li><a class="dropdown-item rounded-2 py-2" href="{{ url_for('admin.users_list') }}"><i class="bi bi-people-fill me-2"></i>用户管理</a></li>
                    <li><a class="dropdown-item rounded-2 py-2" href="{{ url_for('admin.audit_logs') }}"><i class="bi bi-journal-text me-2"></i>操作审计</a></li>
                    {% endif %}
                    
                    <li><hr class="dropdown-divider my-2"></li>
                    <li><a class="dropdown-item rounded-2 py-2 text-danger" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right me-2"></i>退出登录</a></li>
                </ul>
            </div>
            {% endif %}
        </div>
      </div>
    </nav>
    
    <!-- Main Content Area -->
    <main class="main-content fade-in">
        {% block content %}{% endblock %}
    </main>

    <!-- Global Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Theme Management
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
            themeIcon.className = theme === 'dark' ? 'bi bi-sun-fill fs-5' : 'bi bi-moon-stars-fill fs-5';
        }
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
        
        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-bs-theme');
            setTheme(current === 'dark' ? 'light' : 'dark');
        });

        // Global Toast Function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const id = 'toast-' + Date.now();
            let colorClass = 'text-bg-primary';
            let icon = 'info-circle-fill';
            
            if (type === 'success') { colorClass = 'text-bg-success'; icon = 'check-circle-fill'; }
            if (type === 'danger') { colorClass = 'text-bg-danger'; icon = 'exclamation-circle-fill'; }
            
            const html = `
                <div id="${id}" class="toast align-items-center ${colorClass} border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body d-flex align-items-center gap-2">
                            <i class="bi bi-${icon}"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            const wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            container.appendChild(wrapper.firstElementChild);
            
            const toastEl = document.getElementById(id);
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => { toastEl.remove(); });
        }
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>
